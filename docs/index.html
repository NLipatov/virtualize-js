<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Virtualize Demo</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>

<footer>
    <div class="controls">
        <label for="itemCount">
            <span>Items count:</span>
            <input type="number" id="itemCount" placeholder="Count" min="5" value="100">
        </label>
        <button id="renderButton">Render</button>
    </div>
</footer>

<main id="items-container">
    <!-- items will be rendered here -->
</main>

</body>

</html>

<style>
    body {
        margin: 0;
        font-size: 1rem;
    }

    .controls {
        display: flex;
        flex-direction: column;
    }

    button {
        width: 7rem;
    }
</style>

<script>
    'use strict';
    
    const itemsContainer = document.getElementById('items-container');
    const renderButton = document.getElementById('renderButton');
    const itemCountInput = document.getElementById('itemCount');
    
    function render(items, itemsContainer) {
        const containerHeight = itemsContainer.clientHeight;
        const scrollTop = itemsContainer.scrollTop;

        const {startIndex, endIndex} = calculateVisibleElements(items, scrollTop, containerHeight);

        const bufferItemsCount = Math.ceil((endIndex - startIndex) * 1.25);

        const renderStartIndex = Math.max(0, startIndex - bufferItemsCount);
        const renderEndIndex = Math.min(items.length, endIndex + bufferItemsCount);

        const topSpacerHeight = items.slice(0, renderStartIndex).reduce((acc, item) => acc + parseInt(item.style.height, 10), 0);
        const bottomSpacerHeight = items.slice(renderEndIndex).reduce((acc, item) => acc + parseInt(item.style.height, 10), 0);

        itemsContainer.innerHTML = '';

        const topSpacer = document.createElement('div');
        topSpacer.style.height = `${topSpacerHeight}px`;
        itemsContainer.appendChild(topSpacer);

        for (let i = renderStartIndex; i < renderEndIndex; i++) {
            itemsContainer.appendChild(items[i]);
        }

        const bottomSpacer = document.createElement('div');
        bottomSpacer.style.height = `${bottomSpacerHeight}px`;
        itemsContainer.appendChild(bottomSpacer);
    }

    function calculateVisibleElements(items, scrollTop, containerHeight) {
        let startIndex = 0;
        let accumulatedHeight = 0;

        for (let i = 0; i < items.length; i++) {
            accumulatedHeight += parseInt(items[i].style.height, 10);
            if (accumulatedHeight > scrollTop) {
                startIndex = i;
                break;
            }
        }

        let endIndex = startIndex;
        accumulatedHeight = 0;

        for (let i = startIndex; i < items.length; i++) {
            accumulatedHeight += parseInt(items[i].style.height, 10);
            if (accumulatedHeight >= containerHeight) {
                endIndex = i;
                break;
            }
        }

        if (endIndex === startIndex && parseInt(items[startIndex].style.height, 10) > containerHeight) {
            endIndex = startIndex + 1;
        }

        return {startIndex, endIndex};
    }

    const colors = ['#f0f0f0', '#d0e8ff', '#d0ffd0', '#fffacd', '#ffd0d0'];

    let items = [];

    function generateItems(count) {
        items = [];

        for (let i = 0; i < count; i++) {
            const item = document.createElement('div');
            item.textContent = `Item #${i + 1}`;
            item.style.height = `${getRandomHeight(50, 300)}px`;
            item.style.backgroundColor = colors[i % colors.length];
            items.push(item);
        }

        render(items, itemsContainer);
    }

    const getRandomHeight = (min, max) => {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    renderButton.addEventListener('click', function () {
        const count = parseInt(itemCountInput.value, 10);

        if (count > 0) {
            generateItems(count);
            itemsContainer.style.height = `${window.innerHeight - document.querySelector('footer').offsetHeight}px`;
            itemsContainer.style.overflowY = 'scroll';
            render(items, itemsContainer);
        } else {
            alert('Invalid item count!');
        }
    });


    itemsContainer.addEventListener('scroll', () => {
        render(items, itemsContainer);
    });

    window.addEventListener('resize', () => {
        itemsContainer.style.height = `${window.innerHeight - document.querySelector('footer').offsetHeight}px`;
        render(items, itemsContainer);
    });
</script>